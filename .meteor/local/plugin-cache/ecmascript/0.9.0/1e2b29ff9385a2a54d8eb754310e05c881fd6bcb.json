{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"./submission.js","imported":["Submissions","SubmissionResults"],"specifiers":[{"kind":"named","imported":"Submissions","local":"Submissions"},{"kind":"named","imported":"SubmissionResults","local":"SubmissionResults"}]},{"source":"./problem.js","imported":["ProblemTests"],"specifiers":[{"kind":"named","imported":"ProblemTests","local":"ProblemTests"}]},{"source":"child_process","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"ps"}]},{"source":"fs","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"fs"}]}],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"imports/api/_submission.js","filenameRelative":"imports/api/_submission.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/api/_submission.js.map","sourceFileName":"imports/api/_submission.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"_submission"},"ignored":false,"code":"let Submissions, SubmissionResults;\nmodule.watch(require(\"./submission.js\"), {\n\tSubmissions(v) {\n\t\tSubmissions = v;\n\t},\n\n\tSubmissionResults(v) {\n\t\tSubmissionResults = v;\n\t}\n\n}, 0);\nlet ProblemTests;\nmodule.watch(require(\"./problem.js\"), {\n\tProblemTests(v) {\n\t\tProblemTests = v;\n\t}\n\n}, 1);\nlet ps;\nmodule.watch(require(\"child_process\"), {\n\tdefault(v) {\n\t\tps = v;\n\t}\n\n}, 2);\nlet fs;\nmodule.watch(require(\"fs\"), {\n\tdefault(v) {\n\t\tfs = v;\n\t}\n\n}, 3);\nMeteor.methods({\n\t'Submissions.createDir'(id) {\n\t\tSubmissions.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Initializing',\n\t\t\t\tscore: 0\n\t\t\t}\n\t\t});\n\t\tconst submission = Submissions.findOne({\n\t\t\t_id: id\n\t\t});\n\t\tconst dirpath = Meteor.dataPath + id;\n\t\tconst filepath = Meteor.dataPath + id + '/code.' + submission.lang;\n\t\tconst execpath = Meteor.dataPath + id + '/exec';\n\t\tMeteor.wrapAsync(ps.exec)('mkdir -p ' + dirpath);\n\t\tMeteor.wrapAsync(fs.writeFile)(filepath, submission.code);\n\t\tSubmissions.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Compiling'\n\t\t\t}\n\t\t});\n\n\t\ttry {\n\t\t\tif (submission.lang == 'c') {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('gcc ' + filepath + ' -o' + execpath + ' -O2 -std=c99 -lm');\n\t\t\t} else if (submission.lang == 'cpp') {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('g++ ' + filepath + ' -o' + execpath + ' -O2 -std=c++11');\n\t\t\t} else {\n\t\t\t\tSubmissions.update({\n\t\t\t\t\t_id: id\n\t\t\t\t}, {\n\t\t\t\t\t$set: {\n\t\t\t\t\t\tstatus: 'Language Error'\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSubmissions.update({\n\t\t\t\t_id: id\n\t\t\t}, {\n\t\t\t\t$set: {\n\t\t\t\t\tstatus: 'Compile Error'\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tSubmissions.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Running'\n\t\t\t}\n\t\t});\n\t\tconst filter = {\n\t\t\tproblemId: submission.problemId\n\t\t};\n\t\tif (!submission.isExam) filter.isPublic = true;\n\t\tProblemTests.find(filter).forEach(problemTest => {\n\t\t\tMeteor.call('SubmissionResults.insert', problemTest._id, id);\n\t\t});\n\t\tMeteor.call('Submissions.getResult', id);\n\t},\n\n\t'Submissions.removeDir'(id) {\n\t\tconst dirpath = Meteor.dataPath + id;\n\t\tMeteor.wrapAsync(ps.exec)('rm -rf ' + dirpath);\n\t},\n\n\t'Submissions.getResult'(id) {\n\t\tconst result = {\n\t\t\tstatus: null,\n\t\t\tscore: 0\n\t\t};\n\t\tSubmissionResults.find({\n\t\t\tsubmissionId: id\n\t\t}).forEach(submissionResult => {\n\t\t\tif (submissionResult.status == \"Accepted\") result.score += Number(Meteor.getValue(ProblemTests, submissionResult.problemTestId, 'score'));\n\t\t\tif (submissionResult.status != 'Accepted' || result.status == null) result.status = submissionResult.status;\n\t\t});\n\t\tSubmissions.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: result\n\t\t});\n\t},\n\n\t'SubmissionResults.createDir'(id) {\n\t\tSubmissionResults.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Initializing'\n\t\t\t}\n\t\t});\n\t\tconst submissionResult = SubmissionResults.findOne({\n\t\t\t_id: id\n\t\t});\n\t\tconst problemTest = ProblemTests.findOne({\n\t\t\t_id: submissionResult.problemTestId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\ttimeLimit: 1,\n\t\t\t\tmemoryLimit: 1\n\t\t\t}\n\t\t});\n\t\tconst execpath = Meteor.dataPath + submissionResult.submissionId + '/exec';\n\t\tconst inpath = Meteor.dataPath + submissionResult.problemTestId + '/input';\n\t\tconst anspath = Meteor.dataPath + submissionResult.problemTestId + '/output';\n\t\tconst dirpath = Meteor.dataPath + id;\n\t\tconst outpath = Meteor.dataPath + id + '/output';\n\t\tconst respath = Meteor.dataPath + id + '/result';\n\t\tconst execcmd = Meteor.rootPath + 'sandbox/runner ' + problemTest.timeLimit + ' ' + problemTest.memoryLimit + ' ' + execpath + ' < ' + inpath + ' > ' + outpath + ' 2>' + respath;\n\t\tMeteor.wrapAsync(ps.exec)('mkdir -p ' + dirpath);\n\t\tSubmissionResults.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Running'\n\t\t\t}\n\t\t});\n\t\tMeteor.wrapAsync(ps.exec)(execcmd, {\n\t\t\tstdio: 'inherit'\n\t\t});\n\t\tSubmissionResults.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'Judging'\n\t\t\t}\n\t\t});\n\t\tconst result = JSON.parse(Meteor.wrapAsync(fs.readFile)(respath));\n\n\t\tif (result.status == 'OK') {\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('diff -w ' + outpath + ' ' + anspath);\n\t\t\t\tresult.status = 'Accepted';\n\t\t\t} catch (e) {\n\t\t\t\tresult.status = 'Wrong Answer';\n\t\t\t}\n\t\t}\n\n\t\tSubmissionResults.update({\n\t\t\t_id: id\n\t\t}, {\n\t\t\t$set: result\n\t\t});\n\t},\n\n\t'SubmissionResults.removeDir'(id) {\n\t\tconst dirpath = Meteor.dataPath + id;\n\t\tMeteor.wrapAsync(ps.exec)('rm -rf ' + dirpath);\n\t},\n\n\t'SubmissionResults.insert'(problemTestId, submissionId) {\n\t\tconst submissionResultId = SubmissionResults.insert({\n\t\t\tproblemTestId: problemTestId,\n\t\t\tsubmissionId: submissionId,\n\t\t\ttimeUsed: null,\n\t\t\tmemoryUsed: null,\n\t\t\tstatus: 'Pending'\n\t\t});\n\t\tMeteor.call('SubmissionResults.createDir', submissionResultId);\n\t},\n\n\t'SubmissionResults.remove'(filter) {\n\t\tSubmissionResults.find(filter).forEach(submissionResult => {\n\t\t\tMeteor.call('SubmissionResults.removeDir', submissionResult._id);\n\t\t});\n\t\tSubmissionResults.remove(filter);\n\t}\n\n});","map":{"version":3,"sources":["imports/api/_submission.js"],"names":["Submissions","SubmissionResults","module","watch","require","v","ProblemTests","ps","default","fs","Meteor","methods","id","update","_id","$set","status","score","submission","findOne","dirpath","dataPath","filepath","lang","execpath","wrapAsync","exec","writeFile","code","e","filter","problemId","isExam","isPublic","find","forEach","problemTest","call","result","submissionId","submissionResult","Number","getValue","problemTestId","fields","timeLimit","memoryLimit","inpath","anspath","outpath","respath","execcmd","rootPath","stdio","JSON","parse","readFile","submissionResultId","insert","timeUsed","memoryUsed","remove"],"mappings":"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","file":"imports/api/_submission.js.map","sourcesContent":["import { Submissions, SubmissionResults } from './submission.js';\nimport { ProblemTests } from './problem.js';\nimport ps from 'child_process';\nimport fs from 'fs';\n\nMeteor.methods({\n\t'Submissions.createDir'(id) {\n\t\tSubmissions.update({ _id: id }, { $set: { status: 'Initializing', score: 0 }});\n\t\t\n\t\tconst submission = Submissions.findOne({ _id: id });\n\t\tconst dirpath  = Meteor.dataPath+id;\n\t\tconst filepath = Meteor.dataPath+id+'/code.'+submission.lang;\n\t\tconst execpath = Meteor.dataPath+id+'/exec';\n\t\t\n\t\tMeteor.wrapAsync(ps.exec)('mkdir -p '+dirpath);\n\t\tMeteor.wrapAsync(fs.writeFile)(filepath, submission.code);\n\t\t\n\t\tSubmissions.update({ _id: id }, { $set: { status: 'Compiling' }});\n\n\t\ttry{\n\t\t\tif (submission.lang == 'c') {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('gcc '+filepath+' -o'+execpath+' -O2 -std=c99 -lm');\n\t\t\t}\n\t\t\telse if (submission.lang == 'cpp') {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('g++ '+filepath+' -o'+execpath+' -O2 -std=c++11');\n\t\t\t} else {\n\t\t\t\tSubmissions.update({ _id: id }, { $set: { status: 'Language Error' }});\n\t\t\t\treturn;\n\t\t\t}\n\t\t} catch(e) {\n\t\t\tSubmissions.update({ _id: id }, { $set: { status: 'Compile Error' }});\n\t\t\treturn;\n\t\t}\n\t\tSubmissions.update({ _id: id }, { $set: { status: 'Running' }});\n\n\t\tconst filter = { problemId: submission.problemId };\n\t\tif (!submission.isExam) filter.isPublic = true;\n\n\t\tProblemTests.find(filter).forEach((problemTest) => {\n\t\t\tMeteor.call('SubmissionResults.insert', problemTest._id, id);\n\t\t})\n\t\tMeteor.call('Submissions.getResult', id);\n\t},\n\t'Submissions.removeDir'(id) {\n\t\tconst dirpath = Meteor.dataPath+id;\n\t\tMeteor.wrapAsync(ps.exec)('rm -rf '+dirpath);\n\t},\n\t'Submissions.getResult'(id) {\n\t\tconst result = { status: null, score: 0\t};\n\n\t\tSubmissionResults.find({ submissionId: id }).forEach((submissionResult) => {\n\t\t\tif (submissionResult.status == \"Accepted\")\n\t\t\t\tresult.score += Number(Meteor.getValue(ProblemTests, submissionResult.problemTestId, 'score'));\n\t\t\t\n\t\t\tif (submissionResult.status != 'Accepted' || result.status == null)\n\t\t\t\tresult.status = submissionResult.status;\n\t\t});\n\t\tSubmissions.update({ _id: id }, { $set: result });\n\t},\n\t'SubmissionResults.createDir'(id) {\n\t\tSubmissionResults.update({ _id: id }, { $set: { status: 'Initializing' }});\n\n\t\tconst submissionResult = SubmissionResults.findOne({ _id: id });\n\t\tconst problemTest = ProblemTests.findOne({ _id: submissionResult.problemTestId }, { fields: { timeLimit: 1, memoryLimit: 1 }});\n\t\tconst execpath = Meteor.dataPath+submissionResult.submissionId+'/exec';\n\t\tconst inpath  = Meteor.dataPath+submissionResult.problemTestId+'/input';\n\t\tconst anspath = Meteor.dataPath+submissionResult.problemTestId+'/output';\n\t\tconst dirpath = Meteor.dataPath+id;\n\t\tconst outpath = Meteor.dataPath+id+'/output';\n\t\tconst respath = Meteor.dataPath+id+'/result';\n\t\tconst execcmd = Meteor.rootPath+'sandbox/runner '+problemTest.timeLimit+' '+problemTest.memoryLimit+' '+execpath+' < '+inpath+' > '+outpath+' 2>'+respath;\n\n\t\tMeteor.wrapAsync(ps.exec)('mkdir -p '+dirpath);\n\n\t\tSubmissionResults.update({ _id: id }, { $set: { status: 'Running' }});\n\n\t\tMeteor.wrapAsync(ps.exec)(execcmd, { stdio: 'inherit' });\n\n\t\tSubmissionResults.update({ _id: id }, { $set: { status: 'Judging' }});\n\n\t\tconst result = JSON.parse(Meteor.wrapAsync(fs.readFile)(respath));\n\t\t\n\t\tif (result.status == 'OK') {\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(ps.exec)('diff -w '+outpath+' '+anspath);\n\t\t\t\tresult.status = 'Accepted';\n\t\t\t} catch(e) {\n\t\t\t\tresult.status = 'Wrong Answer';\n\t\t\t}\n\t\t}\n\t\tSubmissionResults.update({ _id: id }, { $set: result });\n\t},\n\t'SubmissionResults.removeDir'(id) {\n\t\tconst dirpath = Meteor.dataPath+id;\n\t\tMeteor.wrapAsync(ps.exec)('rm -rf '+dirpath);\n\t},\n\t'SubmissionResults.insert'(problemTestId, submissionId) {\n\t\tconst submissionResultId = SubmissionResults.insert({\n\t\t\tproblemTestId: problemTestId,\n\t\t\tsubmissionId: submissionId,\n\t\t\ttimeUsed: null,\n\t\t\tmemoryUsed: null,\n\t\t\tstatus: 'Pending'\n\t\t});\n\t\tMeteor.call('SubmissionResults.createDir', submissionResultId);\n\t},\n\t'SubmissionResults.remove'(filter) {\n\t\tSubmissionResults.find(filter).forEach((submissionResult) => {\n\t\t\tMeteor.call('SubmissionResults.removeDir', submissionResult._id);\n\t\t});\n\t\tSubmissionResults.remove(filter);\n\t}\n});"]},"hash":"1e2b29ff9385a2a54d8eb754310e05c881fd6bcb"}
